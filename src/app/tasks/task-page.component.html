<nz-layout class="page">
  <nz-header>
    <div class="topbar">
      <div class="brand">
        <span class="logo">✔</span>
        <div class="titles">
          <h1 nz-typography>Mes tâches</h1>
          <p nz-typography>Une todo list simple avec NgRx</p>
        </div>
      </div>
      <div class="user" *ngIf="user$ | async as user">
        <span class="email">{{ user.email }}</span>
        <button nz-button nzType="default" nzSize="small" (click)="logout()">
          Se déconnecter
        </button>
      </div>
    </div>
  </nz-header>

  <nz-content>
    <div class="content" nz-row [nzGutter]="16">
      <div class="left" nz-col [nzSpan]="8">
        <app-task-form
          [editingTask]="editingTask"
          (create)="handleCreate($event)"
          (update)="handleUpdate($event)"
          (cancelEdit)="cancelEdit()"
        ></app-task-form>
      </div>

      <div class="right" nz-col [nzSpan]="16">
        <div class="summary">
          <h2 nz-typography>Mes tâches</h2>
          <div>
            <nz-tag nzColor="blue">
              {{ (tasks$ | async)?.length || 0 }} au total
            </nz-tag>
            <nz-tag nzColor="green">
              {{ pendingCount$ | async }} en cours
            </nz-tag>
          </div>
        </div>

        <nz-table
          *ngIf="tasks$ | async as tasks; else empty"
          [nzData]="tasks"
          nzSize="middle"
          nzBordered
        >
          <thead>
            <tr>
              <th>Titre</th>
              <th>Description</th>
              <th>Priorité</th>
              <th>Échéance</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of tasks" [class.completed]="task.completed">
              <td>{{ task.title }}</td>
              <td>{{ task.description }}</td>
              <td>
                <nz-tag [nzColor]="task.completed ? 'default' : 'geekblue'">
                  P{{ task.priority }}
                </nz-tag>
              </td>
              <td>{{ task.dueDate | date: 'dd/MM/yyyy' }}</td>
              <td>
                <nz-tag [nzColor]="task.completed ? 'success' : 'processing'">
                  {{ task.completed ? 'Terminée' : 'En cours' }}
                </nz-tag>
              </td>
              <td>
                <button
                  nz-button
                  nzSize="small"
                  nzType="default"
                  (click)="toggleCompleted(task)"
                >
                  {{ task.completed ? 'Réouvrir' : 'Terminer' }}
                </button>
                <button
                  nz-button
                  nzSize="small"
                  nzType="link"
                  (click)="startEdit(task)"
                >
                  Modifier
                </button>
                <button
                  nz-button
                  nzSize="small"
                  nzDanger
                  (click)="delete(task)"
                >
                  Supprimer
                </button>
              </td>
            </tr>
          </tbody>
        </nz-table>

        <ng-template #empty>
          <nz-typography>
            Aucune tâche pour le moment. Ajoutez-en une à gauche.
          </nz-typography>
        </ng-template>
      </div>
    </div>
  </nz-content>
</nz-layout>

